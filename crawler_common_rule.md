# クローラー共通仕様

各クローラーの共通仕様をまとめます。

## ストレージサービス

### パーティション設定

仕様

- 取り込み時間: _PARTITIONTIME (UTCの擬似列) 。
    - パーティション単位: DAY, MONTH
- 時間単位の列: 既存テーブルのデータを全削除して取り込む。
    - パーティション単位: DAY, MONTH
    - DATE, TIMESTAMP, DATETIME のいずれかの型のカラムを設定する
- テーブル Suffix: 日付でテーブルを分割する（指定したテーブル名に _yyyy-mm-dd がつく）
- なし: パーティションなしで全データを取り込む。毎回、全データの洗い替えになる。

- **ユースケースと想定しているパーティション設定**
    1. [通常利用] 定期的にファイルを取り込み、追加する。
        - パーティション設定：「取り込み時間」「テーブル Suffix」
            - 日付入りファイル名 (file_2024-08-20.csv など) の日付を指定して取り込む。
            - ファイルの中身のデータの日付とは関係なく、定期実行時に指定した日付のパーティション / テーブルでファイル内の全データを取り込む。
        - 「時間単位の列」は使用しないこと。（取り込み先のテーブルのデータが削除されるため）
    2. [通常利用] 定期実行で取り込んだファイルのデータに誤りがあったので、修正後のファイルを取り込んで修正する or 過去のデータもファイルから取り込む（バックフィル）。
        - パーティション設定：「取り込み時間」「テーブル Suffix」
            - 同設定で定期実行しているテーブルに対し、指定した日付のパーティションへの洗い替えの取り込みになる。
    3. [特別用途] 「時間単位の列」をパーティションとして指定して、1つのファイルから複数のパーティションに分けて取り込む。
        - 想定パーティション設定：「時間単位の列」
            - 指定したカラムでパーティションを作成して取り込む。
                - 複数の日付のデータが入っている場合はパーティションが分かれる。
            - 既存のテーブルに取り込む場合、データを全削除してから取り込む。
                
                ※ 本仕様の理由
                
                - ファイルの中のデータはCollectro取り込み時はわからないため、指定された「時間単位の列」には複数の日付のデータが入っている可能性がある。
                - 取り込み時にパーティションを指定するには、全データが同じ日付である必要があるが、タイムゾーンを考慮すると指定する日付が同一パーティションにならないケースが発生しうる。
                - 定期実行で指定する相対日付、ファイル名日付、データ内の日付が条件を満たさないと取り込めないため、仕様が複雑になり、ユーザーが適切に使用するのが困難になると判断。（特に、ファイル名日付と異なるデータが修正や遅延などで入ることは容易に起きうるため、実運用上、分離するのは困難だと思われる）
                - 一方で、複数の日付のデータが入ったファイルをその日付でパーティショニングして取り込むことができれば、有用であるため、そのため設定として用意する。（取り込み先のテーブルのデータが削除される前提）
        - 想定パーティション設定：「なし」
            - 既存のテーブルに取り込む場合、データを全削除してから取り込む。
            - 「時間単位の列」のパーティションなしバージョン。

### スキーマ自動設定（カラム名を指定）

以下の条件の時の動作を定義する。

- CSVファイル
- スキップする行の数（ユースケースに合わせて適切に設定する）
- スキーマ設定：自動検知
    - カラム名を手動で設定: ON

- 対象クローラー
    
    
    | 7010005 | Google Drive |
    | --- | --- |
    | 7010006 | Box |
    | 7010007 | Dropbox |
- ユースケース
    - ユースケース1: ヘッダ行のあるCSVファイルだが、BQのカラム名として使えないのでカラム名を変更して取り込みたい
    - ユースケース2: ヘッダ行のないCSVファイルにヘッダを設定して取り込みたい
    - ユースケース3: ExcelからエクスポートしたCSVファイルをそのまま取り込みたいので、数行スキップして取り込みたい
    - ユースケース4: CSVファイルの途中から取り込みたい

- 各ユースケースでの設定
    
    以下の設定で取り込むことにより、指定したカラム名で、期待しているデータを全て取り込むことができる。
    
    サンプル：[https://drive.google.com/drive/folders/1LXQwrjsdwDgx_qLQMx8OjZoQTmXuDWP-?hl=ja](https://drive.google.com/drive/folders/1LXQwrjsdwDgx_qLQMx8OjZoQTmXuDWP-?hl=ja)
    
    - ユースケース1: ヘッダ行のあるCSVファイル
        - スキップする行の数: デフォルト（1）
        - サンプルファイル：stock_2024-10-03_standard.csv
    - ユースケース2: ヘッダ行のないCSVファイル
        - スキップする行の数: 0
        - サンプルファイル: stock_2024-10-03_no_headers.csv
    - ユースケース3: ヘッダ行のあるCSVファイル（数行が空行）
        - スキップする行の数: 空行の数+1
            - e.g.) 空行: 3 の場合 → 4 を設定する
        - サンプルファイル: stock_2024-10-03_with_empty_rows.csv （空行3, ヘッダカラム行1）
    - ユースケース4:  CSVファイル（途中から取り込む）
        - スキップする行の数: 取り込むデータの上の行までの数
            - e.g.) 5行目から取り込みたい場合 → 4 を設定する
        - サンプルファイル: stock_2024-10-03_with_dummys.csv （ヘッダカラム行1, ダミー行3）
