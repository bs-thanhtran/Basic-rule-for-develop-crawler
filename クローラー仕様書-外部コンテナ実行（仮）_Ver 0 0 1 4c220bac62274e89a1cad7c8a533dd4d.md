# クローラー仕様書-外部コンテナ実行（仮）_Ver.0.0.1

作成者: Hitoshi Furukawa
status: 開発中
カテゴリ: ユーティリティ

# **概要**

顧客側で準備したコンテナ（以下、外部コンテナ）を起動し、その中でデータを取得・加工した結果をBQに格納するクローラーです。これにより、任意のデータソースからのデータ取得や個別の処理ロジックをCollectroのクローラーとして実行できます。

- 補足）**背景 / 解決したい課題**
    - 特定の顧客により「任意のコード実行ができるクローラー」の要望あり。
        - 課題）現在、Cloud Functions を使って独自実装しているが、個別に起動設定、稼働状況の確認を行う必要がある
    - Collectro で「定期実行」「パラメータのセット」「BQ入力」を担い、ロジック部をユーザーが作成できるようにすることで、以下のようなメリットが期待される。
        - 「定期実行」「バックフィル」「BQ入力」「ログ出力」という処理をCollectroが担うことで、顧客側で独自で開発するよりも開発工数が削減できる。
        - 「実行スケジュール」「実行結果確認」「ログ」が Collectro の他のクローラーと同じ場所で確認できるため、運用での管理ツールを一元化できる。
    

# 基本仕様

## **入力**

以下の表は、入力項目を示しています。

| **項目名** | **必須** | **内容** | Interface Name |
| --- | --- | --- | --- |
| スケジュール | ○ | [毎日/定期実行しない] |  |
| 　定期実行時にデータを取得する範囲 |  | "requiredRelativeDiffTime": true
毎日： 1, -10, 10 (default, min, max) |  |
| イメージ名 | ○ | 外部コンテナのイメージ名
例）gcr.io/collectro-dummy-customer4-gcp/file-convert:v0.0.1

※ Compute Engine default service account がアクセス権を持つコンテナリポジトリであれば利用可能。 | imageName |
| 実行コマンド | ○ | イメージを実行するときの引数（文字列の配列）

例）以下のコマンドを引数に渡す場合の設定
> sh /file-convert.sh 2024-09-01
 ※ 日付はスケジュールで指定

———————————-
1: sh
2: /file-convert.sh | command |
| スキーマ設定 |  |  |  |
| 　スキーマ設定 | ○ | [手動設定 / 自動検知] |  |
| 　スキーマ定義（JSON形式） | ○ | BQに設定するスキーマの型指定
手動設定のときに設定可 |  |
| パーティション |  |  |  |
| 　パーティション列 | ⚪︎ | [なし / 取り込み時間 / 時間単位の列 / テーブル Suffix] |  |
| 　カラム名 |  | パーティションとして利用するカラムの指定
※「時間単位の列」選択で表示 |  |
| 　パーティションタイプ |  | [DAY / MONTH]
※「取り込み時間」または「時間単位の列」選択で表示 |  |
| クラスタリング |  | クラスタリングするカラムの指定 |  |
| 外部のプロジェクトにデータを格納する |  | [チェックボックス] |  |
| 格納先ロケーション | ○ | [格納先ロケーションの内容]
デフォルト: US |  |
| 格納先データセット | ○ | [格納先データセットの内容] |  |
| 格納先テーブル | ○ | [格納先テーブルの内容] |  |
| ~~APIキー~~ |  | [APIキーの内容] |  |

## **出力**

- テーブル：ワークフロー設定のテーブル定義（JSON）を使用する。
- パーティション、クラスタ：ワークフロー設定の設定内容を使用する。

## **動作**

※ 外部コンテナの要件はデベロッパーガイドとして用意する

[(WIP) Collectro 外部コンテナ 開発者ガイド](https://www.notion.so/WIP-Collectro-b762761ea9514b2aa990c09d0f0156a4?pvs=21)

1. ワークフロー設定時
    1. 指定した日付を環境変数 FROM, TO に設定する。
        1. 定期実行しない、追加実行の時に指定した日付(フォーマット：YYYY-MM-DD)が入る。
            
            e.g.) 2024年9月2日から8日まで
            　→ FROM=2024-09-02, TO=2024-09-08
            
        2. 定期実行の場合は、FROM, TO 共に同じ値が入る。
            
            e.g.) 2024年9月25日に「1日前」で実行
            
            　→ FROM=2024-09-24, TO=2024-09-24
            
2. 実行内容
    1. 指定されたイメージを取得する。
    2. 以下のパラメータを指定してイメージを起動する
        1. 必須パラメータ：実行コマンドと実行ファイル
            1. 実行コマンド (e.g. sh)
            2. 実行ファイル (e.g. /file-convert.sh)
    3. /output フォルダを監視し、以下の処理を行う。
        1. log.txt : 1行追加されるたびに Collectro で読み取り可能なフォーマットに変換して 実行ログ用に Cloud Logging に出力する
        2. job_result.txt: 外部コンテナの処理完了を通知する。内容は success または failure 。
            1. success: loadpath.txt を読み込み、GCS のデータを BQ に読み込む。
            2. failure: loadpath.txt は読み込まない。
        3. loadpath.txt: BQテーブルに取り込みたいデータのGCSのパス。
3. クローラーはスキーマ設定に指定された設定で loadpath.txt のGCSのパスにあるファイルをBQテーブルに読み込む。
4. 定期実行しない、追加実行などで期間で指定できる場合、次の日付で[実行内容](https://www.notion.so/00a8647e045c4daabe9e04f15b280e16?pvs=21) の処理を行う。
5. クローラーは外部コンテナのプロセスを監視し、プロセスに異常が検知された場合は異常終了させる。

## ページネーション

- 本クローラーとしてはページネーションはない。

## エラーハンドリング

- ワークフロー設定の読み込み、BQ読み込みでのエラーは標準ルールに従いログに出力する。
- 外部コンテナのエラーはファイル log.txt を参照して顧客向けの情報（実行ログ）としてWriteJobDetails()で出力する

## ログ

- 実行ログ：Poseidon UIで顧客が参照するログ。正常終了、異常終了などの「結果」と、処理の進捗がわかる「詳細」を出力する。以下の標準に従い実装する。
    - [実行ログ](https://www.notion.so/f2c4e9fd8d4e4db7807d6cb729979343?pvs=21)
- システムログ： GKEおよびGCPのロギングに記録され、Hogeエンジニアにて障害調査や利用状況を分析するためのログ。以下の標準に従い実装する。
    - [システムログ](https://www.notion.so/1421fdceed0c40838cf480b135088925?pvs=21)

## ディレクトリ配置とイメージ名

[main.goのディレクトリ構造は本番デプロイのイメージ名と関係しているので、あらかじめ決めておく([cmd/以下](https://www.notion.so/cmd-69fd01e394e743bea1e7bccbd2fe9029?pvs=21) 参照のこと)]

- ディレクトリ: `cmd/utility/private-container/`
- イメージ名: collectro-private-container
- バージョン: 0.0.1

## **参考**

[クローラーを開発する際に参考にしたドキュメント、ライブラリ、ツールなどを列挙します。]

# 認証情報の取得方法

[連携サービスのAPIを使用するために必要なAccess Token等の取得方法を具体的に説明します。]

## 必要な権限

[必要なscope等の権限および設定方法を説明します。]

# Zeus環境情報

<aside>
💡 開発着手時に準備して記載する

</aside>

- メニュー: [メニューIDとメニュー名を事前に取得して記載]

- クローラー: [クローラーIDとクローラー名を事前に取得して記載]
- 手動実行対応:  daily, weekly, monthly, 手動実行のみ [ONにする項目を記載]
- APIキー [開発向け情報。開発完了後、削除する]
    - [APIキーテンプレート名]
        
        ```json
        (新規の場合)
        ```
        
- ワークフロー設定 [開発向け情報。開発完了後、削除する]
    - テンプレート
        
        ```json
        (新規、変更の場合)
        ```
        
- テストで使用するPoseidon環境 [開発向け情報。開発完了後、削除する]
    - collectro-dummy-customer5

# **備考**

[その他、クローラーに関する備考事項を記載します。例えば、制限事項、問い合わせ先など。]

- [制限事項、注意事項、前提条件（契約プランなど）を記載します。]

# 変更履歴

| バージョン | 主な変更内容/PBI |
| --- | --- |
|  |  |
|  |  |